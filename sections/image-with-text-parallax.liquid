<script
  type="application/json"
  data-section-type="image-text-parallax"
  data-section-id="{{ section.id }}"
></script>

{% liquid
  if type == 'block'
    assign object = block
  else
    assign object = section
  endif

  assign id = object.id
  assign blocks = object.blocks
%}

{% style %}
  {% render 'section-space' %}

  {%
    render 'css-loop',
    css: object.settings.custom_css,
    id: id,
  %}

  /* Wrapper for this section only */
  #shopify-section-{{ id }} {
    position: relative;
    overflow: hidden;
  }

  {% if object.settings.parallax_image != blank %}
    /* Parallax background ONLY for this section's wrapper */
    #shopify-section-{{ id }} {
      background-image: url({{ object.settings.parallax_image | image_url: width: 2000 }});
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
    }

    /* Placeholder that reserves height and lets parallax show behind */
    #shopify-section-{{ id }} .image-with-text__parallax-placeholder {
      width: 100%;
      padding-bottom: 75%; /* adjust for visual height */
      display: block;
      background: transparent;
    }
  {% endif %}
{% endstyle %}

<section
  class="
    section
    {% if object.settings.wide_display == false %}
      is-width-standard
    {% else %}
      is-width-wide
      has-no-side-gutter
    {% endif %}
    {% if object.settings.featured_links_per_row == '2' %}
      is-flex
      is-flex-wrap
    {% endif %}
    {{ object.settings.css_class }}
  "
>
  {% if blocks.size > 0 %}
    {% for block in blocks %}
      <div
        class="
          container
          image-with-text-container
          section-{{ forloop.index }}
          featured_collections
          {% if object.settings.featured_links_per_row == '1' %}
            {% if object.settings.frontpage_image_position == 'row' %}
              is-flex-{% cycle 'row', 'row-reverse' %}
            {% else %}
              is-flex-{% cycle 'row-reverse', 'row' %}
            {% endif %}
          {% elsif object.settings.featured_links_per_row == '2' %}
            one-half
            column
            medium-down--one-whole
            is-flex-{{ object.settings.frontpage_image_position }}
            has-no-side-gutter
          {% endif %}
        "
        {{ block.shopify_attributes }}
      >
        {% comment %} Content settings {% endcomment %}
        {%- assign image = block.settings.image -%}
        {% comment %} End content settings {% endcomment %}

        <div
          class="
            featured-link--half
            one-half
            column
            image-with-text__image-column
            is-align-center
            image-with-text__column
            medium-down--one-whole
          "
        >
          <div class="featured-link--wrap">
            <a
              {% if block.settings.link != blank %}
                href="{{ block.settings.link }}"
              {% endif %}
              title="{{ block.settings.title }}"
            >
              {% if image != blank %}
                {% render 'image-element',
                  image: image,
                  alt: image.alt,
                  stretch_width: true,
                  focal_point: image.presentation.focal_point
                %}
              {% else %}
                {%- comment -%}
                  No block image:
                  show placeholder so the parallax background behind
                  the section is visible.
                {%- endcomment -%}
                <span class="image-with-text__parallax-placeholder"></span>
              {% endif %}
            </a>
          </div>
        </div>

        <div class="featured-link--half one-half column image-with-text__text-column is-flex is-align-center image-with-text__column medium-down--one-whole block--{{ block.id }}">
          <div class="info text-align--{{ object.settings.frontpage_text_align }}">
            <a
              {% if block.settings.link != blank %}
                href="{{ block.settings.link }}"
              {% endif %}
              class="collection_title"
            >
              {{ block.settings.title | escape }}
            </a>
            {% if block.settings.text != blank %}
              <div class="description">{{ block.settings.text }}</div>
            {% endif %}
            {% unless block.settings.button_label == blank %}
              {% assign local_text_alpha = block.settings.text_color
                | default: 'rgba(0,0,0,0)'
                | color_extract: 'alpha'
              %}
              {% if local_text_alpha != 0 %}
                <style>
                  .block--{{ block.id }} .global-button {
                    {%
                      render 'text-button-styles',
                      text_color: block.settings.text_color,
                    %}
                  }
                </style>
              {% endif %}
              <a
                {% if block.settings.link != blank %}
                  href="{{ block.settings.link }}"
                {% endif %}
                class="global-button global-button--text image-text__button"
              >
                {{ block.settings.button_label }}
              </a>
            {% endunless %}
          </div>
        </div>
      </div>
    {% endfor %}
  {% endif %}
</section>

<style>
  {% for block in blocks %}
    {%- assign bg_alpha = block.settings.bg_color | default: 'rgba(0,0,0,0)' | color_extract: 'alpha' -%}
    {%- assign text_alpha = block.settings.text_color | default: 'rgba(0,0,0,0)' | color_extract: 'alpha' -%}
    {%- assign bg_gradient = block.settings.bg_color_gradient %}

    {% if bg_gradient != '' %}
      .block--{{ block.id }} {
        background: {{ block.settings.bg_color_gradient }};
      }
    {% elsif bg_alpha != 0 %}
      .block--{{ block.id }} {
        background-color: {{ block.settings.bg_color }};
      }
    {% endif %}

    {% if text_alpha != 0 %}
      .block--{{ block.id }} .collection_title,
      .block--{{ block.id }} p {
        color: {{ block.settings.text_color }};
      }
    {% endif %}
  {% endfor %}

  {% if object.settings.wide_display == false and object.settings.featured_links_per_row == '1' %}
    #shopify-section-{{ object.id }} .image-with-text-container {
      margin-top: 20px;
      margin-bottom: 20px;
    }

    @media only screen and (max-width: 480px) {
      #shopify-section-{{ object.id }} .image-with-text-container {
        margin-bottom: 10%;
      }
    }

  {% elsif object.settings.wide_display == false and object.settings.featured_links_per_row == '2' %}
    @media only screen and (max-width: 480px) {
      #shopify-section-{{ object.id }} .image-with-text-container {
        margin-bottom: 10%;
      }
    }
  {% endif %}
</style>

{% schema %}
{
  "name": "Parallax with text",
  "class": "shopify-section--image-with-text",
  "max_blocks": 16,
  "settings": [
    {
      "type": "checkbox",
      "id": "wide_display",
      "label": "Wide display",
      "default": false
    },
    {
      "type": "select",
      "id": "featured_links_per_row",
      "label": "Images per row",
      "default": "1",
      "options": [
        {
          "value": "1",
          "label": "1"
        },
        {
          "value": "2",
          "label": "2"
        }
      ]
    },
    {
      "type": "text_alignment",
      "id": "frontpage_text_align",
      "label": "Text alignment"
    },
    {
      "type": "select",
      "id": "frontpage_image_position",
      "label": "First image position",
      "info": "Subsequent images will appear staggered",
      "default": "row",
      "options": [
        {
          "value": "row",
          "label": "Left"
        },
        {
          "value": "row-reverse",
          "label": "Right"
        }
      ]
    },
    {
      "type": "header",
      "content": "Parallax background"
    },
    {
      "type": "image_picker",
      "id": "parallax_image",
      "label": "Parallax background image",
      "info": "Shown behind blocks when no image is set on the block."
    },
    {
      "type": "header",
      "content": "Section spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "label": "Top spacing",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "label": "Bottom spacing",
      "default": 0
    },
    {
      "type": "header",
      "content": "Advanced"
    },
    {
      "type": "paragraph",
      "content": "[Learn more](https://help.outofthesandbox.com/hc/en-us/articles/360022329373)"
    },
    {
      "type": "text",
      "id": "css_class",
      "label": "CSS Class"
    },
    {
      "type": "textarea",
      "id": "custom_css",
      "label": "Custom CSS"
    }
  ],
  "blocks": [
    {
      "type": "image",
      "name": "Image with text",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image",
          "info": "1024 x 1024px recommended"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Heading",
          "default": "Your headline"
        },
        {
          "type": "richtext",
          "id": "text",
          "label": "Text",
          "default": "<p>Promotion description appears here.</p>"
        },
        {
          "type": "text",
          "id": "button_label",
          "label": "Button label",
          "default": "View all"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Button link"
        },
        {
          "type": "header",
          "content": "Colors"
        },
        {
          "type": "color",
          "id": "text_color",
          "label": "Text"
        },
        {
          "type": "color",
          "id": "bg_color",
          "label": "Background"
        },
        {
          "type": "color_background",
          "id": "bg_color_gradient",
          "label": "Background gradient"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Parallax with text",
      "category": "Image",
      "settings": {
        "featured_links_per_row": "1",
        "frontpage_text_align": "left"
      },
      "blocks": [
        {
          "type": "image"
        },
        {
          "type": "image"
        }
      ]
    }
  ]
}
{% endschema %}
